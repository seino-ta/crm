# ExecPlan: アーカイブ表示とソフトデリート整合

## メタ情報
- バージョン: v0.1 (2025-11-21 作成)
- オーナー: Codex エージェント
- コンテキスト: アカウント削除はソフトデリートだが、子データが一覧に残り UX が不自然。

## ゴール
1. 通常の CRM 一覧（アカウント/案件/活動/タスク 等）では `deletedAt` が null のレコードのみ表示する。
2. 各メニューに「アーカイブ」ビュー（タブ or トグル）を用意し、削除済みデータを確認できるようにする。
3. API/データ層でフィルタリングをサポートし、Playwright/E2E で削除→アーカイブ表示が確認できる状態にする。

## アプローチ
- **WS1: データレイヤー**
  - `listAccounts` などのフェッチ関数に `includeDeleted` もしくは `status` パラメータ追加。
  - API のクエリ（例: `/accounts?deleted=true`）で `deletedAt` 条件を切り替え可能にする。
- **WS2: UI**
  - アカウント/案件/活動/タスク一覧画面にタブ or SegmentedControl を追加し「アクティブ」「アーカイブ」を切り替える。
  - 削除済みレコードには視覚的なバッジを付ける。
- **WS3: 検証 & ドキュメント**
  - Playwright シナリオに「アカウント削除→アーカイブ表示で確認」を追加。
  - README にアーカイブビューの扱いを記載。

## Progress
- [x] WS1 — Accounts API に `archived` クエリと復元エンドポイントを追加。Opportunities 一覧も親アカウントの削除状況でフィルタできるよう更新。
- [x] WS2 — アカウント一覧/詳細にアーカイブ表示や復元ボタンを導入し、通常ビューでは削除済みを除外。活動ログ・タスクフォームでもアカウント選択に応じて関連案件のみを表示するよう補完し、親子リレーションの整合性を UX 上担保。
- [ ] WS3 — E2E/README 更新は未着手。

## Surprises & Decision Log
- `deletedAt` を子テーブルへ追加せず、親アカウントの状態で各リストをフィルタする方針にした。復元時は親の `deletedAt` をクリアするだけで子データが一覧に戻る。
- Opportunities/Tasks/Activities については段階的にアーカイブビューを追加予定。まずは API レベルで親アカウントの状態を反映させた。
