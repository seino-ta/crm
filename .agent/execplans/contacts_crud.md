# ExecPlan: コンタクト管理メニュー & API 拡張

## メタ情報
- バージョン: v0.1 (2025-11-26 作成)
- オーナー: Codex エージェント
- 参照: AGENTS.md / PLANS.md / archive_views ExecPlan 要件

## 背景
- 現状の UI ではアカウントに紐づくコンタクトを閲覧・管理する画面がなく、案件フォーム等で「コンタクトなし」選択しかできない。
- ユーザー要望: コンタクト専用メニューを追加し、一覧 + 新規作成（将来的には編集削除も）を提供。漢字/カナ検索やアカウント情報の表示が欲しい。
- 既存の `/contacts` API は UI から未使用かつ機能不足のため、柔軟な検索・ソート・監査ログ連携を追加する必要がある。

## ゴール
1. サイドバーに「コンタクト」メニューを追加し、一覧ページ + 新規作成フォームを実装する。
2. 既存の `/contacts` API を拡張（必要ならクエリ追加）し、漢字/カナ検索・アカウントフィルタ・ページネーションをサポートする。新規エンドポイントは作らない。
3. 作成・更新・削除イベントを監査ログへ記録し、Audit Logs 画面にコンタクト操作が反映されるようにする。

## 非ゴール
- コンタクトの一括インポート/エクスポート機能。
- モバイル最適化 UI、詳細画面の高機能化（まずは一覧+作成に集中）。
- 既存アカウント CRUD の大幅なリファクタ（必要最低限の関連表示のみ）。

## ワークストリーム
### WS1: API & データ層拡張
- 既存の `apps/api/src/routes/contacts.ts` / service を拡張し、RESTful エンドポイント（GET/POST/PUT/DELETE）に検索・フィルタ機能を追加。
- クエリ: `search`（氏名、ふりがな、メールを部分一致）、`accountId`、`page`、`pageSize`。`search` は漢字・カナ両対応の `ILIKE` 条件を追加。
- Prisma スキーマで `contacts` に `kanaFirstName`, `kanaLastName` などが無ければ追加し、既存 seed を更新。
- API 呼び出し時に監査ログを発行するヘルパーを整備。

### WS2: Web UI
- `apps/web/src/app/(dashboard)/contacts` 配下に一覧ページを作成。`listContacts` フェッチ関数を拡張してアカウント情報も同時取得。
- 検索フォーム（氏名/カナ/メール）とアカウントフィルタ、ページネーションを実装。アカウント列はリンク化して `/accounts/[id]` へ遷移可能に。
- サイドバーに「コンタクト」メニューを追加し、アクセス制御は既存ロールと同等で OK。
- 新規作成フォームでは必須項目（氏名, メール, アカウント）と任意項目（ふりがな, 電話, 役職, メモ）を入力できるようにし、送信後はトースト表示 + リスト更新。
- 一覧での編集・論理削除 UI を追加し、サーバーアクション経由で `/contacts/:id` の PUT/DELETE を呼び出す。削除は `deletedAt` を設定し、一覧から除外する。
- アカウント詳細画面（`/accounts/[id]`）に関連コンタクトのサマリーを表示し、ドリルダウンできるようにする。

### WS3: 監査ログ & テスト
- API での create/update/delete 時に `AuditAction` を記録し、`Audit Logs` 画面で `entityType = Contact` のレコードが閲覧できるようデータ整備。
- Playwright シナリオに「コンタクト作成→一覧で検索→監査ログ確認」を追加。
- README または既存 ExecPlan に利用手順を追記。

## リスク / 留意事項
- ふりがな検索を実現するため、DB カラム追加が必要。既存データに対しては null 許容にする。
- コンタクト作成時にアカウントの削除状態と整合を取る（アーカイブ済みアカウントには紐づけ不可 or 警告）。
- 監査ログ件数が増えるため、必要に応じてフィルタ追加を検討。

## 次ステップ
- ExecPlan 承認を得た後、WS1 → WS2 → WS3 の順で実装。

## Progress
- [x] WS1: `/contacts` API 拡張、Prisma スキーマ/seed 更新、監査ログ連携
- [x] WS2 (初期): コン タクト一覧/登録 UI・サイドバーメニューを実装
- [x] WS2 (拡張): 編集 UI + 論理削除 UI + アカウント詳細での関連表示
- [x] WS3: Playwright シナリオに編集/削除/関連表示フローを追加し、README に CLI Tips を追記

## Surprises & Discoveries
- `npm --prefix apps/api` コマンドはリポジトリ直下で実行しないと `.env` が読めず Prisma が失敗するため、README に TIP を追記した。
- `Contact` のかなカラムを追加した結果、既存 DB ではマイグレーション適用が必須になった。Seed でもかな情報を埋め込んでテストデータの整合を取っている。

## Decision Log
- Web 側は Server Action ベースで CRUD を統一し、作成/更新/削除のたびに `/contacts` と関連ページを `revalidatePath` する。
- 削除はソフトデリート（`deletedAt`）のみ行い、監査ログの `DELETE` と整合させる。
- アカウント詳細ページでは既存 API (`listContacts` の accountId フィルタ) を利用して軽量に取得し、カード内に最大数件を表示する簡易サマリーとする。
- Playwright テストはメニュー単位の spec（accounts/contacts/opportunities/...）に分割し、個別 CRUD ごとに選択実行できるよう整理した。

## Outcomes & Retrospective
- Web UI での CRUD（作成/編集/論理削除）を統一し、Playwright で一連の CRM フロー + コンタクト編集/削除/アカウント詳細反映まで自動検証できる状態になった。必要に応じて将来のタブ分割やフィルタ拡張を検討する。
